<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.6" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.6">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.6" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.0.6',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Recently, I came upon this issue which bothered me badly as many tools fail to work with that. The symptom is that I can’t rename any file in the file Explorer or command line, both give me an error m">
<meta property="og:type" content="article">
<meta property="og:title" content="A Weird File Rename Issue On Windows7">
<meta property="og:url" content="http://pansila.github.io/posts/b4ce772d/index.html">
<meta property="og:site_name" content="Fantasy and Fiction">
<meta property="og:description" content="Recently, I came upon this issue which bothered me badly as many tools fail to work with that. The symptom is that I can’t rename any file in the file Explorer or command line, both give me an error m">
<meta property="og:image" content="http://pansila.github.io/img/procmon-rename-issue.png">
<meta property="og:image" content="http://pansila.github.io/img/fltmc.jpg">
<meta property="og:updated_time" content="2018-06-01T17:32:22.555Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="A Weird File Rename Issue On Windows7">
<meta name="twitter:description" content="Recently, I came upon this issue which bothered me badly as many tools fail to work with that. The symptom is that I can’t rename any file in the file Explorer or command line, both give me an error m">
<meta name="twitter:image" content="http://pansila.github.io/img/procmon-rename-issue.png">






  <link rel="canonical" href="http://pansila.github.io/posts/b4ce772d/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>A Weird File Rename Issue On Windows7 | Fantasy and Fiction</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Fantasy and Fiction</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
</li>

      
        
        
          
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
</li>

      

      
    </ul>
  

  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://pansila.github.io/posts/b4ce772d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Pansila">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fantasy and Fiction">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">A Weird File Rename Issue On Windows7</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-01T23:36:19+08:00">2018-06-01</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/posts/b4ce772d/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments:</span> <span class="post-comments-count valine-comment-count" data-xid="/posts/b4ce772d/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/posts/b4ce772d/" class="leancloud_visitors" data-flag-title="A Weird File Rename Issue On Windows7">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views:</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Recently, I came upon this issue which bothered me badly as many tools fail to work with that. The symptom is that I can’t rename any file in the file Explorer or command line, both give me an error message saying that <code>access denied</code> or <code>invalid device</code>, I can create a new file though.</p>
<p>To debug what happened under the hood, I wrote a python script to call rename api periodically, and hopes some tool could reveal something.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            os.rename(<span class="string">'test.txt'</span>, <span class="string">'test1.txt'</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>First I use Windbg to attach to the python process, run the program and pause it later, it stops at somewhere that there are lot of int 3 instructions that I don’t familiar with so I gave up. I need a breakpoint! So I look up the CPython source code to see what Win API is used for os.rename, here we got <a href="https://github.com/python/cpython/blob/master/Modules/posixmodule.c#L4105:14" target="_blank" rel="noopener">it</a>, it’s <code>MoveFileExW</code>.</p>
<p>Type in the breakpoint in the windbg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp MoveFileExW</span><br></pre></td></tr></table></figure>
<p>Then more assembly came out, in fact I’m not sure what they are doing, just following the execution flow to see where it exits, and hope will get some useful information about the early abort error.</p>
<pre><code class="arm"><span class="symbol">...</span>
<span class="number">00000000</span>`<span class="number">770</span>d2dd5 ff158d9e0900    call    qword ptr [kernel32!UnhandledExceptionFilter+<span class="number">0x11a8</span> (<span class="number">00000000</span>`<span class="number">7716</span>cc68)] ds:<span class="number">00000000</span>`<span class="number">7716</span>cc68={ntdll!ZwSetInformationFile (<span class="number">00000000</span>`<span class="number">77359</span>b10)}
<span class="number">0</span>:<span class="number">000</span>&gt; p
<span class="symbol">kernel32</span>!<span class="keyword">MoveFileExW+0x27b:</span>
<span class="keyword">00000000`770d2ddb </span><span class="number">89842480000000</span>  <span class="keyword">mov </span>    dword ptr [rsp+<span class="number">80</span>h],eax ss:<span class="number">00000000</span>`<span class="number">0026</span>f190<span class="number">=0281</span>af48
<span class="number">0</span>:<span class="number">000</span>&gt; p
<span class="symbol">kernel32</span>!<span class="keyword">MoveFileExW+0x282:</span>
<span class="keyword">00000000`770d2de2 </span><span class="number">65488</span>b042530000000 <span class="keyword">mov </span>  rax,qword ptr gs:[<span class="number">30</span>h] gs:<span class="number">00000000</span>`<span class="number">00000030</span>=????????????????
<span class="number">0</span>:<span class="number">000</span>&gt; p
<span class="symbol">kernel32</span>!<span class="keyword">MoveFileExW+0x28b:</span>
<span class="keyword">00000000`770d2deb </span><span class="number">488</span>b4860        <span class="keyword">mov </span>    rcx,qword ptr [rax+<span class="number">60</span>h] ds:<span class="number">000007</span>ff`fffde060<span class="number">=000007</span>fffffd6000
<span class="number">0</span>:<span class="number">000</span>&gt; p
<span class="symbol">kernel32</span>!<span class="keyword">MoveFileExW+0x28f:</span>
<span class="keyword">00000000`770d2def </span><span class="number">4</span>c8b8424b8000000 <span class="keyword">mov </span>    <span class="built_in">r8</span>,qword ptr [rsp+<span class="number">0</span>B8h] ss:<span class="number">00000000</span>`<span class="number">0026</span>f1c8<span class="number">=00000000004508</span>a0
<span class="number">0</span>:<span class="number">000</span>&gt; p
<span class="symbol">kernel32</span>!<span class="keyword">MoveFileExW+0x297:</span>
<span class="keyword">00000000`770d2df7 </span><span class="number">33</span><span class="built_in">d2</span>            xor     edx,edx
<span class="number">0</span>:<span class="number">000</span>&gt; p
<span class="symbol">kernel32</span>!<span class="keyword">MoveFileExW+0x299:</span>
<span class="keyword">00000000`770d2df9 </span><span class="number">488</span>b4930        <span class="keyword">mov </span>    rcx,qword ptr [rcx+<span class="number">30</span>h] ds:<span class="number">000007</span>ff`fffd6030<span class="number">=00000000003</span>f0000
<span class="number">0</span>:<span class="number">000</span>&gt; p
<span class="symbol">kernel32</span>!<span class="keyword">MoveFileExW+0x29d:</span>
<span class="keyword">00000000`770d2dfd </span>ff15c59e0900    call    qword ptr [kernel32!UnhandledExceptionFilter+<span class="number">0x1208</span> (<span class="number">00000000</span>`<span class="number">7716</span>ccc8)] ds:<span class="number">00000000</span>`<span class="number">7716</span>ccc8={ntdll!RtlFreeHeap (<span class="number">00000000</span>`<span class="number">7731</span>a020)}
<span class="number">0</span>:<span class="number">000</span>&gt; p
<span class="symbol">kernel32</span>!<span class="keyword">MoveFileExW+0x2a3:</span>
<span class="keyword">00000000`770d2e03 </span><span class="number">8</span>b8c2480000000  <span class="keyword">mov </span>    ecx,dword ptr [rsp+<span class="number">80</span>h] ss:<span class="number">00000000</span>`<span class="number">0026</span>f190<span class="symbol">=c00000ba</span>
<span class="number">0</span>:<span class="number">000</span>&gt; p
<span class="symbol">kernel32</span>!<span class="keyword">MoveFileExW+0x2aa:</span>
<span class="keyword">00000000`770d2e0a </span><span class="number">85</span><span class="built_in">c9</span>            test    ecx,ecx
<span class="number">0</span>:<span class="number">000</span>&gt; p
<span class="symbol">kernel32</span>!<span class="keyword">MoveFileExW+0x2ac:</span>
<span class="keyword">00000000`770d2e0c </span><span class="number">0</span>f88a2060200    js      kernel32!GetModuleHandleW+<span class="number">0x13f4</span> (<span class="number">00000000</span>`<span class="number">770</span>f34b4) [<span class="keyword">br=1]</span>
<span class="keyword">0:000&gt; </span>p
<span class="symbol">kernel32</span>!GetModuleHandleW+<span class="number">0x13f4</span>:
<span class="number">00000000</span>`<span class="number">770</span>f34b4 <span class="number">81</span>f9d40000c0    <span class="keyword">cmp </span>    ecx,<span class="number">0</span>C00000D4h
<span class="number">0</span>:<span class="number">000</span>&gt; p
<span class="symbol">kernel32</span>!GetModuleHandleW+<span class="number">0x13fa</span>:
<span class="number">00000000</span>`<span class="number">770</span>f34ba <span class="number">7408</span>            je      kernel32!GetModuleHandleW+<span class="number">0x1404</span> (<span class="number">00000000</span>`<span class="number">770</span>f34c4) [<span class="keyword">br=0]</span>
<span class="keyword">0:000&gt; </span>p
<span class="symbol">kernel32</span>!GetModuleHandleW+<span class="number">0x13fc</span>:
<span class="number">00000000</span>`<span class="number">770</span>f34bc <span class="number">81</span>f9380019c0    <span class="keyword">cmp </span>    ecx,<span class="number">0</span>C0190038h
<span class="number">0</span>:<span class="number">000</span>&gt; p
<span class="symbol">kernel32</span>!GetModuleHandleW+<span class="number">0x1402</span>:
<span class="number">00000000</span>`<span class="number">770</span>f34c2 <span class="number">754</span>c            jne     kernel32!GetModuleHandleW+<span class="number">0x1450</span> (<span class="number">00000000</span>`<span class="number">770</span>f3510) [<span class="keyword">br=1]</span>
<span class="keyword">0:000&gt; </span>p
<span class="symbol">kernel32</span>!GetModuleHandleW+<span class="number">0x1450</span>:
<span class="number">00000000</span>`<span class="number">770</span>f3510 e80be5ffff      call    kernel32!<span class="keyword">BaseSetLastNTError </span>(<span class="number">00000000</span>`<span class="number">770</span>f1a20)
<span class="number">0</span>:<span class="number">000</span>&gt; p
<span class="symbol">kernel32</span>!GetModuleHandleW+<span class="number">0x1455</span>:
<span class="number">00000000</span>`<span class="number">770</span>f3515 e9fff8fdff      jmp     kernel32!<span class="keyword">MoveFileExW+0x2b9 </span>(<span class="number">00000000</span>`<span class="number">770</span>d2e19)
<span class="symbol">...</span>
</code></pre>
<p>Here we got <code>ZwSetInformationFile</code>, I didn’t notice it in the first place since I don’t have any idea about windows driver development.</p>
<p>I went for the <a href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/procmon" target="_blank" rel="noopener">Process Monitor</a> (procmon), a tool provided by Microsoft to track all kinds of system events.</p>
<p><img src="/img/procmon-rename-issue.png" alt=""></p>
<p>It’s Chinese, the messages say that renaming failed because API thinks the target file name is actually a directory. Well it’s not of course!</p>
<p>After googling a lot, I realized that it’s a minifilter issue that some malfunctioned minifilter dirver intercepts the rename request and drops it accidentally or intentionally. We have fltmc.exe to list them all.</p>
<p><img src="/img/fltmc.jpg" alt=""></p>
<p><code>FileInfo</code> and <code>luafv</code> are legal drivers form Microsoft, while <code>eamonm</code> is a driver file form ESET, an anti virus software, you’d think it should be innocent? No, it’s the culprit, after uninstalling it, the issue gone. What the heck! An anti-virus software doing a virus thing!</p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/233799e4/" rel="next" title="Compile openocd for ARM platform">
                <i class="fa fa-chevron-left"></i> Compile openocd for ARM platform
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Pansila</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate"> 
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Pansila</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Gemini</a> v6.0.6</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.6"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.6"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.6"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.6"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.6"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.6"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.6"></script>



  



	





  





  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'qBTseCeEXIm7y4BLwe05EVy9-gzGzoHsz',
        appKey: 'Vo7kIJagaWoBbHKtppisGPj0',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("qBTseCeEXIm7y4BLwe05EVy9-gzGzoHsz", "Vo7kIJagaWoBbHKtppisGPj0");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            
            counter.save(null, {
              success: function(counter) {
                
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.get('time'));
                
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            
              var newcounter = new Counter();
              /* Set ACL */
              var acl = new AV.ACL();
              acl.setPublicReadAccess(true);
              acl.setPublicWriteAccess(true);
              newcounter.setACL(acl);
              /* End Set ACL */
              newcounter.set("title", title);
              newcounter.set("url", url);
              newcounter.set("time", 1);
              newcounter.save(null, {
                success: function(newcounter) {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                },
                error: function(newcounter, error) {
                  console.log('Failed to create');
                }
              });
            
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  
  

  

  

  

  

</body>
</html>
