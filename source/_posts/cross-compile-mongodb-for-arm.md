---
title: Cross compile mongodb for 32 bit arm
abbrlink: ae66dec5
date: 2018-03-23 23:06:10
tags:
---

I'd like to run a relatively modern mongodb server on my cubieboard which is powered by an ARMv7l chip. There was a good [work](http://facat.github.io/cross-compile-mongodb-for-arm.html) but it was built against 2.6.3 thus a bit out-dated. The latest version of mongodb that supports 32 bit platform is 3.3.15. That's what I'd like to try here.

1. Prepare the build environment
  
   ```bash
   $ sudo apt-get install build-essential wget scons
   $ sudo apt-get install libboost-filesystem-dev libboost-program-options-dev libboost-system-dev libboost-thread-dev
   $ sudo apt-get install g++-5-arm-linux-gnueabihf g++-5-arm-linux-gnueabihf
   ```

2. You might need to update the cross-compile toolchain accordingly to make `arm-linux-gnueabihf-gcc` point to the correct version, details see this [post](posts/14894ce3/).

   ``` bash
   $ sudo update-alternatives --install /usr/bin/arm-linux-gnueabihf-gcc arm-linux-gnueabihf-gcc /usr/bin/arm-linux-gnueabihf-gcc-5 100 --slave /usr/bin/arm-linux-gnueabihf-g++ arm-linux-gnueabihf-g++ /usr/bin/arm-linux-gnueabihf-g++-5
   ```

3. Download and unpack mongodb source code

   ```bash
   $ mkdir install
   $ cd install
   $ wget https://fastdl.mongodb.org/src/mongodb-src-r3.3.15.tar.gz
   $ tar xvf mongodb-src-r3.3.15.tar.gz
   $ cd mongodb-src-r3.3.15
   ```

4. Generate additional sources. It's suggested by [this post](https://groups.google.com/forum/#!msg/mongodb-dev/G-kGjZEEam0/VSVB9fYCBAAJ).

   ```bash
   $ cd src/third_party/mozjs-45/
   $ ./get_sources.sh
   $ ./gen-config.sh arm linux
   $ cd -
   ```
   As I was doing it, an error raised saying a file missed.
   ```bash
   fatal error: js-config.h: No such file or directory
   ```
   Therefore some extra parameters were added in the file `gen-config.sh` to fix it.
   ```bash
   PYTHON=python ./configure --without-intl-api --enable-posix-nspr-emulation --disable-trace-logging --host=arm-linux --target=arm-linux-gnueabihf --build=x86_64-linux
   ```

5. Some modifications to move on.
   
   * No pause implementation.

     Error message:

     ```bash
     In file included from src/mongo/util/concurrency/spin_lock.cpp:34:0:
     src/mongo/platform/pause.h:71:2: error: #error "No processor pause implementation for this architecture."
      #error "No processor pause implementation for this architecture."
     src/mongo/util/concurrency/spin_lock.cpp: In member function 'void mongo::SpinLock::_lockSlowPath()':
     src/mongo/util/concurrency/spin_lock.cpp:57:34: error: 'MONGO_YIELD_CORE_FOR_SMT' was not declared in this scope
         MONGO_YIELD_CORE_FOR_SMT();
     ```

     Modification:
     
     mongo uses some processor pause signal to make CPU work more effectively, arm (armv7l) is out of support in this case, add it along with aarch64 in the file `src/mongo/platform/pause.h`.

     ```c
     #elif defined(__aarch64) || defined(__arm__)

     #define MONGO_YIELD_CORE_FOR_SMT() __asm__ volatile("yield" ::: "memory")
     ```

   * `config.h` missing for gperftools 2.5

     Error message:

     ```bash
     src/third_party/gperftools-2.5/src/base/dynamic_annotations.c:38:20: fatal error: config.h: No such file or directory
     ```

     Modification:

     The missed file is generated by `./configure`, download a gperftools source code.
     ```bash
     $ wget https://github.com/gperftools/gperftools/releases/download/gperftools-2.5.93/gperftools-2.5.93.tar.gz
     $ tar xf gperftools-2.5.93.tar.gz
     $ cd gperftools-2.5.93
     $ ./configure --target=arm-linux-gnueabihf --host=arm-linux --build=x86_64-linux
     ```

     Find the file in the path `src/config.h`, copy it to the mongo third party directory `src/third_party/gperftools-2.5/build_linux_arm`.

6. Compile and build.
   
   ```bash
   $ scons mongo mongod --wiredtiger=off --mmapv1=on CC=arm-linux-gnueabihf-gcc CXX=arm-linux-gnueabihf-g++
   ```

7. Reduce binaries file size.

   ```bash
   $ strip -s build/opt/mongo
   $ strip -s build/opt/mongod
   ```

8. Install binaries

   Copy all the binaries to the cubieboard.

   ```bash
   $ sudo cp mongo mongod /usr/local/bin/
   ```

---
Credits:

* [Compile and install MongoDB on Raspberry PI](http://koenaerts.ca/compile-and-install-mongodb-on-raspberry-pi/)
* [Cross Compile MongoDB for ARM](http://facat.github.io/cross-compile-mongodb-for-arm.html)